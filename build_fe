#!/bin/bash

## This script can build
# -  /react-components on Sazerac Cif Core Components
# -  /ui.frontend on (BTD, Mr Boston, Fireball, SOCO)
# 
# Projects will be built in order supplied. Can pass up to 5.
# 
# [+] <script.sh> cif mrboston fireball soco btd


## Requirements
# nvm -- (node@10 and node@12)
# aemsync (cmdline version)

##  CHANGE THESE FOR YOUR ENVIRONMENT ##	
SCC='/Users/rcbranham/code/sazerac/sazerac-cif-core-components/'
BTD='/Users/rcbranham/code/sazerac/aem_buffalotracedistillery/'
FB='/Users/rcbranham/code/sazerac/aem_fireball/'
BOST='/Users/rcbranham/code/sazerac/aem_mr_boston/'
SOCO='/Users/rcbranham/code/sazerac/aem_sazerac_blueprint/'
NVM_HOME='. ~/.nvm/nvm.sh'
##




main() {
	# check for aemsync  
	type aemsync &>/dev/null || 
		{ echo "aemsync is required, but it's not installed. Aborting."; exit 1; }

	# check for nvm
	{ eval $NVM_HOME; command -v nvm >/dev/null; } || 
		{ echo "nvm is required, but it's not installed.  Aborting."; exit 1; }
	
	# print usage and exit if no cmd line args
	if [ "$#" -eq 0  ]; then
		usage
	fi
	
	# loop through args and build each 
	for var in "$@"
	do
    		case $var in
			-h | -H | --help | help | Help)
				usage
				;;

			cif | CIF)
				build_cif 
				;;

			BTD | btd | Btd)
	  			build_btd
	  			;;

			mrboston | MrBoston)
	  			build_bost
	  			;;

			fireball | Fireball)
	  			build_fb
	  			;;

			soco | Soco)
				build_soco
				;;
		esac
	done
}

# build CIF react-components with node v12
build_cif() {
	echo '[+] building cif react-components';
	eval $NVM_HOME;
	(cd $SCC/react-components/; pwd; nvm use 12; npm run webpack:dev && echo 'done';)
}

# build BTD frontend with node v12
build_btd() {
	echo '[+] building BTD';
	eval $NVM_HOME;
	(cd $BTD/ui.frontend/; nvm use 12; npm run dev && echo 'done';)
	(cd $BTD/ui.apps/src/main/content/jcr_root/apps/buffalotracedistillery/clientlibs/; 
		aemsync -t http://admin:admin@localhost:4502 -p clientlib-site/;)
}

# build Mr Boston frontend with node v12
build_bost() {
	echo '[+] building mrboston';
	eval $NVM_HOME;
	(cd $BOST/ui.frontend/; nvm use 12; npm run dev && echo 'done';)
	(cd $BOST/ui.apps/src/main/content/jcr_root/apps/mrboston/clientlibs/; 
	 	aemsync -t http://admin:admin@localhost:4502 -p clientlib-site/;)
}

# build Fireball frontend with node v12
build_fb() {
	echo '[+] building fireball';
	eval $NVM_HOME;
	(cd $FB/ui.frontend/; nvm use 12; npm run dev && echo 'done';)
	(cd $FB/ui.apps/src/main/content/jcr_root/apps/fireball/clientlibs/; 
	 	aemsync -t http://admin:admin@localhost:4502 -p clientlib-site/;)
}

# build Southern Comfort frontend with node v10
build_soco() {
	echo '[+] building soco';
	eval $NVM_HOME;
	(cd $SOCO/ui.frontend.soco/; nvm use 10; npm run dev && echo 'done';)
	(cd $SOCO/ui.apps/src/main/content/jcr_root/apps/sazerac-aem-blueprint/clientlibs/soco/clientlib-site-soco; 
	 	aemsync -t http://admin:admin@localhost:4502 -p clientlib-site-soco/;)
}

# print usage and exit
usage() {
	printf '\n[+] Will build the frontend on all sites given through cmd line args'
	printf '\n[+] Projects will be built in order supplied. Can pass up to 5.'
	printf '\n\n[+] Usage: <script.sh> cif mrboston btd fireball soco\n\n';
	exit 1;
}

main "$@"
